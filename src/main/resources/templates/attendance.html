<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Management - LazyHR</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/lazyhr/css/common.css" />
    <link rel="stylesheet" href="/lazyhr/css/attendance.css" />
  </head>
  <body>
    <!-- Sidebar using fragment -->
    <div th:replace="~{fragments/sidebar :: sidebar('attendance', ${user})}"></div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container-fluid p-4">
        <!-- Header using fragment -->
        <div th:replace="~{fragments/common :: pageHeader('Attendance Management', 'Manage your daily attendance and view records', null)}"></div>

        <!-- Error Alert using fragment -->
        <div th:replace="~{fragments/common :: alert('danger', ${error}, 'exclamation-triangle')}" th:if="${error}"></div>

      <!-- Clock In/Out Card -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-stopwatch me-2"></i>Clock In/Out
              </h5>
            </div>
            <div class="card-body text-center">
              <div id="currentTime" class="time-display mb-3">--:--:--</div>
              <div class="mb-3">
                <span class="badge bg-info fs-6" id="currentDate">Today</span>
              </div>

              <div
                th:if="${hasUser != null and hasUser == true and user != null}"
                class="d-grid gap-2"
              >
                <button
                  class="btn btn-success btn-clock btn-lg"
                  onclick="clockIn()"
                >
                  <i class="fas fa-sign-in-alt me-2"></i>Clock In
                </button>
                <button
                  th:if="${isClockedIn}"
                  class="btn btn-danger btn-clock btn-lg"
                  onclick="clockOut()"
                >
                  <i class="fas fa-sign-out-alt me-2"></i>Clock Out
                </button>
              </div>

              <div
                th:if="${hasUser == null or hasUser == false or user == null}"
                class="alert alert-warning"
              >
                <i class="fas fa-exclamation-triangle me-2"></i>
                No user information available. Please contact administrator.
              </div>

              <!-- Current Status -->
              <div th:if="${activeAttendance}" class="mt-3">
                <small class="text-muted">Clocked in at: </small>
                <strong
                  class="time-format"
                  th:attr="data-timestamp=${activeAttendance.clockInTime}"
                  th:text="${activeAttendance.clockInTime}"
                  >09:00</strong
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Today's Summary -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-calendar-day me-2"></i>Today's Summary
              </h5>
            </div>
            <div class="card-body">
              <div
                th:if="${todayAttendances != null && !todayAttendances.isEmpty()}"
              >
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Clock In</th>
                        <th>Clock Out</th>
                        <th>Hours</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="record : ${todayAttendances}">
                        <td
                          class="time-format"
                          th:attr="data-timestamp=${record.clockInTime}"
                          th:text="${record.clockInTime != null ? record.clockInTime : '--:--:--'}"
                        >
                          09:00
                        </td>
                        <td
                          class="time-format"
                          th:attr="data-timestamp=${record.clockOutTime}"
                          th:text="${record.clockOutTime != null ? record.clockOutTime : '--:--:--'}"
                        >
                          --:--
                        </td>
                        <td
                          th:text="${record.totalHours != null ? record.totalHours + 'h' : '0h'}"
                        >
                          0h
                        </td>
                        <td>
                          <span
                            th:class="'badge fs-6 ' + (${record.status.name()} == 'PRESENT' ? 'bg-success' : (${record.status.name()} == 'LATE' ? 'bg-warning' : 'bg-secondary'))"
                            th:text="${record.status}"
                            >Present</span
                          >
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div
                th:unless="${todayAttendances != null && !todayAttendances.isEmpty()}"
                class="text-center text-muted"
              >
                <i class="fas fa-clock fs-1 mb-3"></i>
                <p>No attendance record for today</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Monthly Attendance Table -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-calendar me-2"></i>This Month's Attendance
              </h5>
            </div>
            <div class="card-body">
              <div
                th:if="${monthlyAttendance != null && !monthlyAttendance.isEmpty()}"
                class="table-responsive"
              >
                <table
                  class="table table-hover"
                  th:data-timestamp="${timestamp}"
                >
                  <thead class="table-dark">
                    <tr>
                      <th>Date</th>
                      <th>Day</th>
                      <th>Clock In</th>
                      <th>Clock Out</th>
                      <th>Total Hours</th>
                      <th>Status</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      th:each="attendance : ${monthlyAttendance}"
                      th:class="'attendance-card ' + ${attendance.status.name().toLowerCase()}"
                    >
                      <td
                        class="date-format"
                        th:attr="data-timestamp=${attendance.attendanceDate}"
                        th:text="${attendance.attendanceDate}"
                      >
                        Dec 15, 2024
                      </td>
                      <td
                        class="day-format"
                        th:attr="data-timestamp=${attendance.attendanceDate}"
                        th:text="${attendance.attendanceDate}"
                      >
                        Monday
                      </td>
                      <td
                        class="time-format"
                        th:attr="data-timestamp=${attendance.clockInTime}"
                        th:text="${attendance.clockInTime != null ? attendance.clockInTime : '-'}"
                      >
                        09:00
                      </td>
                      <td
                        class="time-format"
                        th:attr="data-timestamp=${attendance.clockOutTime}"
                        th:text="${attendance.clockOutTime != null ? attendance.clockOutTime : '-'}"
                      >
                        17:30
                      </td>
                      <td
                        th:text="${attendance.totalHours != null ? attendance.totalHours + 'h' : '-'}"
                      >
                        8.5h
                      </td>
                      <td>
                        <span
                          th:class="'badge ' + (${attendance.status.name()} == 'PRESENT' ? 'bg-success' : (${attendance.status.name()} == 'LATE' ? 'bg-warning text-dark' : (${attendance.status.name()} == 'ABSENT' ? 'bg-danger' : 'bg-info')))"
                          th:text="${attendance.status}"
                          >Present</span
                        >
                      </td>
                      <td th:text="${attendance.notes ?: '-'}">Good work</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div
                th:unless="${monthlyAttendance != null && !monthlyAttendance.isEmpty()}"
                class="text-center text-muted py-5"
              >
                <i class="fas fa-calendar-times fs-1 mb-3"></i>
                <p>No attendance records found for this month</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/lazyhr/js/constants.js"></script>
    <script src="/lazyhr/js/common-utils.js"></script>
    <script src="/lazyhr/js/attendance.js"></script>
    <script th:inline="javascript">
      // Initialize user data from Thymeleaf template
      document.addEventListener("DOMContentLoaded", function() {
        const userId = /*[[${user != null ? user.id : 0}]]*/ 0;
        const hasUser = /*[[${hasUser != null ? hasUser : false}]]*/ false;
        initializeUserData(userId, hasUser);
      });
    </script>
  </body>
</html>
